# CustomTNTFlow

CustomTNTFlow — это Paper/Spigot-плагин, позволяющий описывать множество типов «умного» TNT, которые автоматически помечаются собственными NBT-данными, мгновенно активируются при установке и передают информацию во внешние плагины (например, аддон ProtectionStones) через API и кастомные события.

## Возможности

- Любое число типов TNT в `config.yml` — для каждого настраиваются материал предмета, имя, лор, кастом-модель, свечение, дополнительные PersistentData-значения и тэги сущности.
- TNT подменяется примед-сущностью сразу после установки блока (если включено `ignite-when-placed`), что исключает дюпы и гарантирует корректную работу с регионами (если другой плагин отменит установку блока, TNT не активируется).
- Тонкая настройка поведения взрыва: радиус, разрешённые/запрещённые блоки, особое отношение к обсидиану, возможность работать под водой, ограничение количества разрушаемых блоков, дроп предметов.
- Режим `api-only`: плагин не ломает блоки самостоятельно, а лишь сообщает список кандидатов через событие `RegionTNTDetonateEvent`, чтобы другой модуль снял «хп» приватного блока.
- Простое API (`RegionTNTAPI`) для поиска типа по предмету или сущности, а также кастомное событие `RegionTNTDetonateEvent`, которое можно отменить или изменить список блоков.
- Команда `/regiontnt` с подкомандами `list`, `info`, `give`, `reload` и таб-комплитом.

## Конфигурация

Главный файл `config.yml` содержит секции:

- `messages` — настройки сообщений (например, текст при активации заряда).
- `types` — набор описаний TNT. Каждая запись имеет три вложенных блока:
  - `item` — внешний вид предмета, списки `hidden-flags`, дополнительные NBT (`persistent-data`).
  - `primed` — параметры сущности: имя, время до взрыва, сила, флаг `explode-in-water`, scoreboard-тэги, свои PDC (`persistent-data`) и набор `nbt-markers`, который сохраняется напрямую в NBT (требуется установленный NBT-API).
  - `behavior` — логика взаимодействия с блоками: авто-поджиг (`ignite-when-placed`), радиус, whitelisт/blacklist, опции дропа, флаги `allow-obsidian`, `allow-fluids`, `max-blocks`, а также `api-only` для полного контроля сторонним плагином.

Примеры трёх готовых типов (`default`, `obsidian_breaker`, `water_bomber`) включены в конфиг и демонстрируют разные сценарии: TNT, которое вообще не ломает блоки, обсидиановый «бур», и гидробомба с дропом блоков.

## API и интеграция

### RegionTNTAPI (опционально)

1. Получите инстанс через `RegionTNTAPI.get()` — плагин инициализирует API при включении.
2. Вызовите `findType(ItemStack)` или `findType(Entity)`, чтобы определить тип и получить объект `RegionTNTType`.
3. Подпишитесь на `RegionTNTDetonateEvent`, чтобы перехватывать список блоков до разрушения. Событие можно отменить или модифицировать, а в режиме `api-only` — обработать разрушения самостоятельно.
4. Используйте `RegionTNTRegistry#getEffectiveTraits(Entity)` для чтения итоговых параметров, если нужно восстановить актуальные настройки во время взрыва.

### Интеграция через NBT (без API)

- Каждый предмет и примед-сущность получают PersistentData-ключ `customtntflow:tnt_type` с идентификатором типа и `customtntflow:traits` с JSON-описанием поведения.
- В секции `primed.nbt-markers` можно описать дополнительные поля, которые будут записаны напрямую в NBT (требуется установленный NBT-API). Поддерживаются строки, числа и boolean. Пример:

  ```yaml
  primed:
    nbt-markers:
      CustomTNTFlowType: "{type}"
      CustomTNTFlowRadius: "{radius}"
      CustomTNTFlowDrops: true
  ```

- Значения поддерживают плейсхолдеры `{type}`, `{radius}`, `{drops}`, `{obsidian}`, `{water}`.
- Любой плагин, использующий NBT-API, может читать эти ключи через `NBT.get(entity, ...)` или `NBT.modify(entity, ...)` и реагировать без прямого обращения к `RegionTNTAPI`.

## Команды и права

- `/regiontnt help` — справка (право `regiontnt.use`, по умолчанию есть у всех).
- `/regiontnt list` — список доступных типов.
- `/regiontnt info <type>` — краткая информация по типу.
- `/regiontnt give <player> <type> [amount]` — выдаёт предмет (право `regiontnt.give`).
- `/regiontnt reload` — перечитывает конфигурацию с диска (право `regiontnt.reload`).

## Сборка

Проект использует Gradle, Java 21 (целевой `release` 21) и зависимость `spigot-api:1.20.1-R0.1-SNAPSHOT`.

> ⚠️ В репозиторий намеренно не добавлен Gradle Wrapper (`gradlew`, `gradlew.bat`, `gradle-wrapper.jar`), чтобы избежать бинарных файлов. 
> Перед сборкой установите Gradle 8.x локально или сгенерируйте wrapper вручную (`gradle wrapper`).

```bash
gradle build
```

Собранный JAR появится в `build/libs`. Дополнительно доступна задача `gradle copyPlugin`, копирующая артефакт в `build/output/`.
